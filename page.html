
<canvas id="game" width="520" height="380">

</canvas>
<script>
    colors = ["blue","red","yellow","green"];
    directions = ["up","down","left","right"];
    cellCoords=[];
    keyPresses = 1;
    freshBlockRate = 12;
    minBlocks = 4;
    maxBlocks = 8;
    bombs= 1;
    score= 0;
    bombCost = 6;
    currentColor = 0;
    gridSize = 20; //20px tiles
    tileCount = 19; //grid of 19x19 tiles
    ax = 15;
    ay = 15;

    px=9;
    py=9;

    trail=[];
    tail = 5;
    class Cell{
        constructor(x,y,color,gridCellSize){
            //grid coords
            this.y = y;
            this.x = x;

            //indicative of having these borders
            this.top = true; 
            this.bottom = true;
            this.left = true;
            this.right= true;
            this.color = color;
            this.cellSize = gridCellSize;
        }
        openSide(side,context)
        {
            switch(side){
                case "bottom":
                    this.bottom = false;
                    break;
                case "top":
                    this.top = false;
                    break;
                case "left": 
                    this.left = false;
                    break;
                case "right":
                    this.right = false;
                    break;
            }
            this.drawCell(context);
        }
        drawCell(context)
        {
            ctx.fillStyle="white";
            ctx.fillRect(this.x,this.y,this.cellSize,this.cellSize);
            var drawX = this.x + (this.left ? 1 : 0);
            var drawY = this.y + (this.top ? 1 : 0);
            var height = this.cellSize - (this.bottom ? 1 : 0) - (this.top ? 1 : 0);
            var width = this.cellSize - (this.left ? 1 : 0) - (this.right ? 1 : 0);

            ctx.fillStyle=this.color;
            ctx.fillRect(drawX,drawY,width,height);
        }
        changeColor(color,context){
            this.color = color;
            this.drawCell(context);
        }
    }
    window.onload = function() {
        canvas = document.getElementById("game");
        ctx = canvas.getContext("2d");
        document.addEventListener("keydown",keyPush);
        setInterval(gameFrame, 1000/15);
        ctx.fillStyle="gray";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        
        for(var i = 0;i<tileCount;i++){
            for(var j = 0; j < tileCount; j++){
                ctx.fillStyle="black";
                ctx.fillRect(i*gridSize,j*gridSize,gridSize,gridSize);
            }
        }
        for(var i = 0;i<tileCount;i++){
            var cells = [];
            for(var j = 0; j < tileCount; j++){
                var thisCell = new Cell(i*gridSize,j*gridSize,colors[Math.floor(Math.random()*colors.length)],gridSize);
                thisCell.drawCell(ctx);
                cells.push(thisCell);
            }
            cellCoords.push(cells);
        }

        for(var i = 0; i < tileCount; i++){
            for(var j = 0; j < tileCount; j++){
                var thisCell = cellCoords[i][j];
                if(j > 0){
                    if(thisCell.color == cellCoords[i][j-1].color){
                        thisCell.openSide("top",ctx);
                        cellCoords[i][j-1].openSide("bottom",ctx);
                    }
                }
                if(j + 1 < tileCount){
                    if(thisCell.color == cellCoords[i][j+1].color){
                        thisCell.openSide("bottom",ctx);
                        cellCoords[i][j+1].openSide("top",ctx);
                    }
                }
                if(i > 0){
                    if(thisCell.color == cellCoords[i-1][j].color){
                        thisCell.openSide("left",ctx);
                        cellCoords[i-1][j].openSide("right",ctx);
                    }
                }
                if(i + 1 < tileCount){
                    if(thisCell.color == cellCoords[i+1][j].color){
                        thisCell.openSide("right",ctx);
                        cellCoords[i+1][j].openSide("left",ctx);
                    }
                }

            }
        }
    }
    function keyPush(event){
        cellCoords[px][py].changeColor("black",ctx);
        //maybe use this instead to change px py rather than xv yv
        var moved = false;
        var currentCell = cellCoords[px][py];
        switch(event.keyCode){
            case 37: //left
                keyPresses++;
                var targetCell = cellCoords[px-1][py];
                if(px >0){
                    if(currentCell.left && bombs > 0){
                        bombs--;
                        currentCell.openSide("left",ctx);
                        targetCell.openSide("right",ctx);
                        px--;
                    } else  if (currentCell.left == false) {
                        currentCell.openSide("left",ctx);
                        targetCell.openSide("right",ctx);
                        px--;
                    } else if (targetCell.color == "black"){
                        currentCell.openSide("left",ctx);
                        targetCell.openSide("right",ctx);
                        px--;

                    }
                    moved = colors.includes(cellCoords[px][py].color);
                }
                break;
            case 38: //up
                keyPresses++;
                var targetCell = cellCoords[px][py-1];
                if(py > 0){
                    if(currentCell.top && bombs > 0){
                        bombs --;
                        currentCell.openSide("top",ctx);
                        targetCell.openSide("bottom",ctx);
                        py--
                    } else if (currentCell.top == false){
                        currentCell.openSide("top",ctx);
                        targetCell.openSide("bottom",ctx);
                        py--;
                    }else if (targetCell.color == "black"){
                        currentCell.openSide("top",ctx);
                        targetCell.openSide("bottom",ctx);
                        py--;
                    }
                    moved = colors.includes(cellCoords[px][py].color);
                }
                break;
            case 39: //right
                keyPresses++;
                var targetCell = cellCoords[px + 1][py];
                if(px<tileCount - 1){
                    if(currentCell.right && bombs > 0){
                        bombs--;
                        currentCell.openSide("right",ctx);
                        targetCell.openSide("left",ctx);
                        px++;
                    }
                    else if(currentCell.right == false){
                        currentCell.openSide("right",ctx);
                        targetCell.openSide("left",ctx);
                        px++;
                    }
                    else if(targetCell.color == "black"){
                        currentCell.openSide("right",ctx);
                        targetCell.openSide("left",ctx);
                        px++;
                    }
                    moved = colors.includes(cellCoords[px][py].color);
                }
                break;
            case 40: //down
                keyPresses++;
                var targetCell = cellCoords[px][py + 1];
                if(py<tileCount - 1){
                    if(currentCell.bottom && bombs > 0){
                        bombs--;
                        currentCell.openSide("bottom",ctx);
                        targetCell.openSide("top")
                        py++;
                    } else if (currentCell.bottom == false){
                        currentCell.openSide("bottom",ctx);
                        targetCell.openSide("top")
                        py++;
                    } else if (targetCell.color == "black"){
                        currentCell.openSide("bottom",ctx);
                        targetCell.openSide("top")
                        py++;
                    }
                    moved = colors.includes(cellCoords[px][py].color);
                }
                break;
        }
        if(moved){
            score ++;
            if (score % 6 == 0 ){
                bombs++;
            }
        }
    }
    function gameFrame(){
        ctx.fillStyle="white";
        ctx.fillRect(px*gridSize,py*gridSize,gridSize,gridSize);
        document.getElementById("score").innerText = score;
        document.getElementById("bombs").innerText = bombs;
        document.getElementById("keypresses").innerText = keyPresses;
        for(var i = 0; i < tileCount; i++){
            for(var j = 0; j < tileCount; j++){
                var thisCell = cellCoords[i][j];
                if (i != px && j != py){
                    if(j > 0){
                        if(thisCell.color == "black" && cellCoords[i][j-1].color == "black"){
                            thisCell.openSide("top",ctx);
                            cellCoords[i][j-1].openSide("bottom",ctx);
                        }
                    }
                    if(j + 1 < tileCount){
                        if(thisCell.color  == "black" &&  cellCoords[i][j+1].color == "black" ){
                            thisCell.openSide("bottom",ctx);
                            cellCoords[i][j+1].openSide("top",ctx);
                        }
                    }
                    if(i > 0){
                        if(thisCell.color == "black" &&  cellCoords[i-1][j].color == "black" ){
                            thisCell.openSide("left",ctx);
                            cellCoords[i-1][j].openSide("right",ctx);
                        }
                    }
                    if(i + 1 < tileCount){
                        if(thisCell.color == "black" && cellCoords[i+1][j].color == "black" ){
                            thisCell.openSide("right",ctx);
                            cellCoords[i+1][j].openSide("left",ctx);
                        }
                    }
                }
            }
        }
        /*
        ctx.fillStyle="white";
        for(var i = 0; i< trail.length;i++){
            ctx.fillRect(trail[i].x*gridSize, trail[i].y*gridSize, gridSize - 2, gridSize -2);
            if(trail[i].x == px && trail[i].y==py){
                tail = 5;
            }
        }
        trail.push({x:px,y:py});
        while(trail.length> tail){
            trail.shift();
        }
        if (ax == px && ay == py){
            tail++;
            ax= Math.floor(Math.random()*tileCount);
            ay= Math.floor(Math.random()*tileCount)
        }
        ctx.fillStyle="red";
        ctx.fillRect(ax*gridSize,ay*gridSize,gridSize - 2, gridSize - 2);
        */
    }
</script>
<div class="title">
    Starting Title
</div>
<div>
    Score:
    <div id="score">
        0
    </div>
    Bombs:
    <div id="bombs">

    </div>
    Keypresses:
    <div id="keypresses">

    </div>
</div>